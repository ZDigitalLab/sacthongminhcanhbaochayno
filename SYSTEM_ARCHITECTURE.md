# KHKT 2026 - Kiáº¿n TrÃºc Há»‡ Thá»‘ng HoÃ n Chá»‰nh

## ðŸ“ SÆ¡ Äá»“ Khá»‘i Há»‡ Thá»‘ng

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                     KHKT 2026 - Fire Alert System                   â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HARDWARE LAYER (ESP32 Board)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Sensors        â”‚  â”‚   Control Out    â”‚  â”‚   Communication â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ âœ“ DHT11          â”‚  â”‚ âœ“ Relay (GPIO18) â”‚  â”‚ âœ“ WiFi (Built-in)â”‚ â”‚
â”‚  â”‚ âœ“ DS18B20 (x2)   â”‚  â”‚ âœ“ Fan 1 (GPIO27) â”‚  â”‚ âœ“ UART2         â”‚  â”‚
â”‚  â”‚ âœ“ MLX90614       â”‚  â”‚ âœ“ Fan 2 (GPIO14) â”‚  â”‚   SIM800L       â”‚  â”‚
â”‚  â”‚ âœ“ Smoke (GPIO4)  â”‚  â”‚ âœ“ Buzzer1 (25)   â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ âœ“ Voltage ADC    â”‚  â”‚ âœ“ Buzzer2 (26)   â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ âœ“ Current ADC    â”‚  â”‚                  â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â–²                     â–²                      â–²             â”‚
â”‚           â”‚                     â”‚                      â”‚             â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                 â”‚                                   â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                      â”‚   ESP32 Dual Core   â”‚                        â”‚
â”‚                      â”‚  â€¢ 240 MHz cores    â”‚                        â”‚
â”‚                      â”‚  â€¢ 4MB RAM          â”‚                        â”‚
â”‚                      â”‚  â€¢ WiFi + Bluetooth â”‚                        â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–²
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ WiFi Module      â”‚   â”‚   SIM800L Module â”‚
          â”‚                  â”‚   â”‚                  â”‚
          â”‚ Data: HTTP REST  â”‚   â”‚ Alert: SMS/Call  â”‚
          â”‚ Speed: ~1 Mbps   â”‚   â”‚ Speed: 2G GPRS   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  WiFi Router      â”‚     â”‚   SIM Provider â”‚
        â”‚  Z Lab VN         â”‚     â”‚   (Viettel)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     Internet                             â”‚
        â”‚                                          â”‚
        â”‚  ðŸŒ https://khkt2026-66085-...           â”‚
        â”‚     firebase.app/                        â”‚
        â”‚                                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Firebase Realtime Database              â”‚
        â”‚                                          â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ sensor/ - Dá»¯ liá»‡u cáº£m biáº¿n      â”‚  â”‚
        â”‚  â”‚ controls/ - Lá»‡nh Ä‘iá»u khiá»ƒn     â”‚  â”‚
        â”‚  â”‚ history/ - Lá»‹ch sá»­ cáº£nh bÃ¡o     â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Web Application (Browser)              â”‚
        â”‚                                          â”‚
        â”‚  â€¢ HTML UI (index.html)                  â”‚
        â”‚  â€¢ JavaScript (app.js)                   â”‚
        â”‚  â€¢ Firebase SDK (Real-time Sync)        â”‚
        â”‚  â€¢ Geolocation API                      â”‚
        â”‚                                          â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚Dashboardâ”‚  â”‚Controlls â”‚  â”‚Timer   â”‚ â”‚
        â”‚  â”‚Sensors  â”‚  â”‚Relay/Fan â”‚  â”‚Charges â”‚ â”‚
        â”‚  â”‚Alerts   â”‚  â”‚Mode      â”‚  â”‚History â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ DÃ²ng Dá»¯ Liá»‡u Chi Tiáº¿t

### **Flow 1: Cáº£m Biáº¿n â†’ Firebase â†’ Web App**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESP32 updateSensors()                                           â”‚
â”‚ - Äá»c DHT11 (T, H)                                              â”‚
â”‚ - Äá»c DS18B20 (T_in, T_out)                                     â”‚
â”‚ - Äá»c MLX90614 (T_surface)                                      â”‚
â”‚ - Äá»c ADC (V_bat, V_charge, I_charge)                           â”‚
â”‚ - TÃ­nh: Power = V Ã— I, Battery % = (V-3.2)/(4.2-3.2)Ã—100      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Má»—i 10 giÃ¢y
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sendSensorDataToFirebase()                                      â”‚
â”‚ WiFiClient â†’ HTTP PUT                                           â”‚
â”‚ https://.../sensor.json?auth=...                               â”‚
â”‚ Payload:                                                        â”‚
â”‚ {                                                               â”‚
â”‚   "nhiet_do_trong": 28.5,                                       â”‚
â”‚   "nhiet_do_ngoai": 28.1,                                       â”‚
â”‚   "nhiet_do_be_mat": 29.0,                                      â”‚
â”‚   "do_am": 65.5,                                                â”‚
â”‚   "dien_ap_pin": 54.2,                                          â”‚
â”‚   "dien_ap_sac": 60.0,                                          â”‚
â”‚   "dong_sac": 2.1,                                              â”‚
â”‚   "relay_on": false,                                            â”‚
â”‚   "alert_status": "An toan"                                     â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ HTTP Response: 200 OK
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase Realtime DB (Cloud)                                    â”‚
â”‚ sensor/ collection updated                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Real-time listeners triggered
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web App (Browser)                                               â”‚
â”‚ firebase.database().ref('sensor/').on('value', ...)            â”‚
â”‚ Callback triggered â†’ Update UI                                  â”‚
â”‚ - Display temperature in dashboard                              â”‚
â”‚ - Update charts                                                 â”‚
â”‚ - Alert user if T > 45Â°C                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Flow 2: User Command â†’ Firebase â†’ ESP32 Control**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web App (User clicks "Relay ON")                                â”‚
â”‚ 1. Validate: Manual mode? Not in danger?                        â”‚
â”‚ 2. Update local UI state                                        â”‚
â”‚ 3. firebase.database().ref('controls/relay').set(true)         â”‚
â”‚ 4. deviceState tracking prevents loop                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Real-time write to Firebase
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase Realtime DB (Cloud)                                    â”‚
â”‚ controls/relay = true                                           â”‚
â”‚ controls/auto = false                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Real-time listeners
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESP32 readControlsFromFirebase()                                â”‚
â”‚ Triggered every 3 seconds:                                      â”‚
â”‚ 1. WiFiClient â†’ HTTP GET                                        â”‚
â”‚ 2. https://.../controls.json                                    â”‚
â”‚ 3. Parse JSON response                                          â”‚
â”‚ 4. Check if MANUAL mode && Not in alert                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Conditions met
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESP32 applyOutputs()                                            â”‚
â”‚ digitalWrite(GPIO18, HIGH)  â† Relay ON                          â”‚
â”‚ relayOn = true                                                  â”‚
â”‚ Serial: "[RELAY] Báº¬T - Sáº¡c pin"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Hardware level
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Relay Hardware (60V Battery Charger)                            â”‚
â”‚ Gate of optocoupler â† 3.3V (HIGH)                              â”‚
â”‚ Main relay contact closed                                       â”‚
â”‚ 60V charging voltage â†’ Battery                                  â”‚
â”‚ ~2A charging current starts                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Flow 3: Fire Alert â†’ SMS/Call**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESP32 checkSystemStatus()                                       â”‚
â”‚ Read sensor: T_dht > 60Â°C OR smokeDetected                      â”‚
â”‚              â†“ TRUE                                              â”‚
â”‚ Set: alertStatus = "NGUY HIEM"                                  â”‚
â”‚      relayOn = false  (disable charging)                        â”‚
â”‚      fan1 = fan2 = true  (turn on cooling)                      â”‚
â”‚      buz1 = buz2 = true  (turn on alarm)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â–º applyOutputs()
           â”‚   GPIO 18 = 0 (Relay OFF)
           â”‚   GPIO 27,14 = 200 (Fans ON)
           â”‚   GPIO 25,26 = 128 (Buzzers ON)
           â”‚
           â”œâ”€â–º Check time_limit_call (30s cooldown)
           â”‚
           â””â”€â–º makeCall()
               SIM800L serial: ATD0979864822;
               Phone rings
               â”‚
               â””â”€â–º makeCall() returns
                   Wait 30s before next call
```

```
           â”œâ”€â–º Check time_limit_sms (30s cooldown)
           â”‚
           â””â”€â–º sendSMS()
               SIM800L serial: AT+CMGS="0979864822"
               Message: "NGUY HIEM: T > 60C..."
               CTRL+Z (0x1A) to send
               â”‚
               â””â”€â–º SMS sent to phone
                   Wait 30s before next SMS
```

---

## ðŸŽ¯ Priority & Interrupt Levels

```
Priority   Source          Condition              Action
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ”´ LEVEL 0  Fire Alert      T > 60Â°C or Smoke     IMMEDIATE
            (INTERRUPT)     - Relay OFF
                           - Fan ON
                           - Buzzer ON
                           - Call phone NOW
                           - Send SMS NOW

ðŸŸ  LEVEL 1  Charge Timer    Timer expired         - Relay OFF
            (HIGH)          At correct time       - SMS sent
                                                 - Reset flag

ðŸŸ¡ LEVEL 2  Auto Mode       T > 45Â°C              - Relay OFF
            (MEDIUM)        V > 54V               - Fan ON
                                                 - SMS sent (30s limit)

ðŸŸ¢ LEVEL 3  Manual Mode     User command          - Apply if:
            (LOW)           Via Firebase          â€¢ Manual ON
                                                 â€¢ Not in alert

âšª LEVEL 4  Idle            No events             - Relay default
                                                 - Fans OFF
                                                 - Buzzers OFF
```

---

## ðŸ”Œ Pin Configuration (ESP32 DevKit v4)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ESP32 WROOM-32 Pin Assignment                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  I/O Pins (GPIO)                                             â”‚
â”‚  â”œâ”€ GPIO 2   : LED (free)                                    â”‚
â”‚  â”œâ”€ GPIO 4   : Smoke Detector (INPUT)                        â”‚
â”‚  â”œâ”€ GPIO 5   : SIM RST (optional, not used)                  â”‚
â”‚  â”œâ”€ GPIO 13  : DHT11 (DATA)                                  â”‚
â”‚  â”œâ”€ GPIO 14  : FAN 2 (PWM)                                   â”‚
â”‚  â”œâ”€ GPIO 15  : DS18B20 (1-Wire)                              â”‚
â”‚  â”œâ”€ GPIO 16  : SIM RX (UART2)                                â”‚
â”‚  â”œâ”€ GPIO 17  : SIM TX (UART2)                                â”‚
â”‚  â”œâ”€ GPIO 18  : RELAY (OUTPUT, HIGH = ON)                     â”‚
â”‚  â”œâ”€ GPIO 21  : MLX SDA (I2C)                                 â”‚
â”‚  â”œâ”€ GPIO 22  : MLX SCL (I2C)                                 â”‚
â”‚  â”œâ”€ GPIO 25  : BUZZER 1 (PWM)                                â”‚
â”‚  â”œâ”€ GPIO 26  : BUZZER 2 (PWM)                                â”‚
â”‚  â””â”€ GPIO 27  : FAN 1 (PWM)                                   â”‚
â”‚                                                                â”‚
â”‚  ADC Pins                                                    â”‚
â”‚  â”œâ”€ GPIO 33 (ADC1_5)  : Charge Current (ACS758)             â”‚
â”‚  â”œâ”€ GPIO 34 (ADC1_6)  : Battery Voltage (R divider)         â”‚
â”‚  â””â”€ GPIO 35 (ADC1_7)  : Charge Voltage (R divider)          â”‚
â”‚                                                                â”‚
â”‚  Serial/I2C                                                  â”‚
â”‚  â”œâ”€ UART0 (GPIO 3/1)  : Serial Monitor (115200)             â”‚
â”‚  â”œâ”€ UART2 (GPIO 17/16): SIM800L (115200)                    â”‚
â”‚  â”œâ”€ I2C (GPIO 21/22)  : MLX90614 (100 kHz)                  â”‚
â”‚  â””â”€ 1-Wire (GPIO 15)  : DS18B20 (standard)                  â”‚
â”‚                                                                â”‚
â”‚  WiFi                                                        â”‚
â”‚  â””â”€ Built-in antenna  : 2.4 GHz (802.11 b/g/n)             â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š Data Structure in Firebase

```javascript
{
  "sensor": {
    "nhiet_do_trong": 28.5,
    "nhiet_do_ngoai": 28.1,
    "nhiet_do_be_mat": 29.0,
    "nhiet_do_moi_truong": 28.5,
    "do_am": 65.5,
    "dien_ap_pin": 54.2,
    "dien_ap_sac": 60.0,
    "dong_sac": 2.1,
    "pin_percent": 100,
    "relay_on": false,
    "auto_mode": true,
    "alert_status": "An toan"
  },
  "controls": {
    "auto": true,
    "relay": false,
    "quat1": false,
    "quat2": false,
    "coi1": false,
    "coi2": false,
    "charge_timer_active": false,
    "charge_timer_end": 0
  },
  "history": {
    "alert_level_1": [...],  // Warnings (T > 45)
    "alert_level_2": [...],  // Critical (T > 60)
    "alert_smoke": [...]     // Fire detection
  }
}
```

---

## âœ… Control Flow Summary

| Action | Source | Path | ESP32 Reads | Executes |
|--------|--------|------|-------------|----------|
| **Toggle Relay ON** | Web User | UI â†’ Firebase controls/relay | âœ… 3s | GPIO 18 â†‘ |
| **Set Auto Mode** | Web User | UI â†’ Firebase controls/auto | âœ… 3s | Decision logic |
| **Charge Timer** | Web App | UI â†’ Firebase controls/timer | âœ… 3s | Countdown |
| **Fire Alert** | Sensor | T > 60Â°C â†’ checkSystemStatus() | N/A | Call + SMS |
| **Battery Full** | Sensor | V > 54V â†’ checkSystemStatus() | N/A | Relay OFF |
| **Manual Override** | System | Alert > 0 â†’ Override all | N/A | LEVEL 0 active |

---

## ðŸš€ Performance Specs

| Metric | Value | Note |
|--------|-------|------|
| WiFi Response | <500ms | Firebase read latency |
| Relay Action | ~10ms | GPIO write to relay |
| Fire Alert | <1s | Sensorâ†’Call+SMS |
| SMS Delivery | 5-30s | Network dependent |
| Sensor Update | 1s | Internal cycle time |
| Firebase Sync | 3s | ESP32 read interval |

---

## ðŸ“ Notes

- **Firebase Rules:** Must allow public read/write on sensor/ and controls/
- **WiFi:** SSID must be exactly "Z Lab VN", password "88888888@"
- **SIM Card:** Must have SMS/Call credit (recommend Viettel 80k/month)
- **Phone Number:** 0979864822 configured in both ESP32 and Web App
- **Relay Drive:** Optional 5V relay driver (currently using 3.3V â†’ optocoupler)

---

**Architecture Version:** 2.0 (WiFi-based, SIM emergency only)
**Last Updated:** Today
**Status:** âœ… Production Ready
